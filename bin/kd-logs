#!/bin/sh
# Get logs from a deplyment quickly

set -eu

if [ ! -x "$(which kubectl 2>/dev/null)" ]; then
  echo "please install: kubectl (https://kubernetes.io/docs/tasks/kubectl/install/)" >&2
  exit 1
fi
if [ ! -x "$(which fzf 2>/dev/null)" ]; then
  echo "please install: fzf (https://github.com/junegunn/fzf)" >&2
  exit 1
fi

if readlink "$0" >/dev/null; then
  source="$(readlink "$0")"
  dir=$(cd "$(dirname "$0")/$(dirname "$source")" && pwd)
  prefix="$dir/.."
else
  prefix="$(dirname "$0")/.."
fi

current="$(kubectl config current-context)"
selected=$( (kubectl get deployments -o jsonpath="{.items[*].metadata.name}" | xargs -n 1 ) \
        | fzf -0 -1 --tac -q "${1:-""}" --prompt "${current}>" )
if [ ! -z "$selected" ]; then
  echo $selected
  kubectl logs deployment/$selected
fi
